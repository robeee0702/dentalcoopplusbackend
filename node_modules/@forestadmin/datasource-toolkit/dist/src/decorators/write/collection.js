"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const errors_1 = require("../../errors");
const collection_decorator_1 = __importDefault(require("../collection-decorator"));
const leaf_1 = __importDefault(require("../../interfaces/query/condition-tree/nodes/leaf"));
const unpaginated_1 = __importDefault(require("../../interfaces/query/filter/unpaginated"));
const projection_1 = __importDefault(require("../../interfaces/query/projection"));
const record_1 = __importDefault(require("../../validation/record"));
const schema_1 = __importDefault(require("../../utils/schema"));
const context_1 = __importDefault(require("./context"));
class WriteDecorator extends collection_decorator_1.default {
    constructor() {
        super(...arguments);
        this.replacedDefinitions = {};
    }
    replaceFieldWriting(fieldName, definition) {
        if (!Object.keys(this.schema.fields).includes(fieldName)) {
            throw new Error(`The given field "${fieldName}" does not exist on the ${this.name} collection.`);
        }
        this.replacedDefinitions[fieldName] = definition;
        this.markSchemaAsDirty();
    }
    refineSchema(childSchema) {
        const schema = { ...childSchema, fields: { ...childSchema.fields } };
        for (const name of Object.keys(this.replacedDefinitions)) {
            schema.fields[name].isReadOnly = false;
        }
        return schema;
    }
    async create(caller, data) {
        return Promise.all(data.map(record => this.applyDefinitionsAndCreate(caller, record)));
    }
    async update(caller, filter, patch) {
        await this.applyDefinitionsAndUpdate(caller, filter, patch);
    }
    async applyDefinitionsAndCreate(caller, record) {
        const patch = await this.applyDefinitions(caller, record, 'create');
        if (this.getRelationFields(patch, ['ManyToOne', 'OneToOne']).length === 0) {
            const result = await this.childCollection.create(caller, [patch]);
            return result[0];
        }
        const manyToOneRecords = await this.createManyToOneRelations(caller, patch);
        const createdRecord = await this.createRecord(caller, patch, manyToOneRecords);
        await this.createOneToOneRelations(caller, patch, createdRecord);
        return createdRecord;
    }
    async applyDefinitionsAndUpdate(caller, filter, patch) {
        const updatedPatch = await this.applyDefinitions(caller, patch, 'update');
        const relations = this.getRelationFields(updatedPatch, ['OneToOne', 'ManyToOne']);
        const idsList = await this.getImpactedRecordByUpdate(caller, relations, filter);
        await Promise.all([
            ...this.updateAllRelations(caller, idsList, updatedPatch),
            this.childCollection.update(caller, filter, this.getPatchWithoutRelations(updatedPatch, relations)),
        ]);
    }
    async createRecord(caller, patch, manyToOneRecords) {
        const refinedPatch = { ...patch };
        const manyToOneRelations = this.getRelationFields(patch, ['ManyToOne']);
        for (const [record] of manyToOneRecords) {
            const relationName = manyToOneRelations.shift();
            const relationSchema = this.schema.fields[relationName];
            delete refinedPatch[relationName];
            const relation = this.dataSource.getCollection(relationSchema.foreignCollection);
            const [pk] = schema_1.default.getPrimaryKeys(relation.schema);
            refinedPatch[relationSchema.foreignKey] = record[pk];
        }
        for (const relationName of this.getRelationFields(patch, ['OneToOne'])) {
            const relationSchema = this.schema.fields[relationName];
            delete refinedPatch[relationName];
            if (patch[relationSchema.originKey])
                delete refinedPatch[relationSchema.originKey];
        }
        const result = await this.childCollection.create(caller, [refinedPatch]);
        return result[0];
    }
    async createOneToOneRelations(caller, patch, createdRecord) {
        const requests = [];
        for (const oneToOneRelation of this.getRelationFields(patch, ['OneToOne'])) {
            const relationSchema = this.schema.fields[oneToOneRelation];
            const relationRecord = patch[oneToOneRelation];
            const relation = this.dataSource.getCollection(relationSchema.foreignCollection);
            const fk = relationSchema.originKey;
            if (patch[fk]) {
                const conditionTree = new leaf_1.default(fk, 'Equal', patch[fk]);
                const filter = new unpaginated_1.default({ conditionTree });
                const update = relation.update(caller, filter, relationRecord);
                requests.push(update);
            }
            else {
                const [pk] = schema_1.default.getPrimaryKeys(this.schema);
                requests.push(relation.create(caller, [{ ...relationRecord, [fk]: createdRecord[pk] }]));
            }
        }
        await Promise.all(requests);
    }
    createManyToOneRelations(caller, patch) {
        const resultsManyToOne = [];
        for (const relationName of this.getRelationFields(patch, ['ManyToOne'])) {
            const relationSchema = this.schema.fields[relationName];
            const relationRecord = patch[relationName];
            const fk = relationSchema.foreignKey;
            const relation = this.dataSource.getCollection(relationSchema.foreignCollection);
            if (patch[fk]) {
                const [pk] = schema_1.default.getPrimaryKeys(relation.schema);
                const updateWrapper = async () => {
                    const conditionTree = new leaf_1.default(pk, 'Equal', patch[fk]);
                    await relation.update(caller, new unpaginated_1.default({ conditionTree }), relationRecord);
                    return [{ [pk]: patch[fk] }];
                };
                resultsManyToOne.push(updateWrapper());
            }
            else {
                resultsManyToOne.push(relation.create(caller, [relationRecord]));
            }
        }
        return Promise.all(resultsManyToOne);
    }
    updateAllRelations(caller, listIds, patch) {
        const updates = [];
        const relations = this.getRelationFields(patch, ['OneToOne', 'ManyToOne']);
        for (const recordIds of listIds) {
            const relationName = relations.shift();
            const relationSchema = this.schema.fields[relationName];
            const relation = this.dataSource.getCollection(relationSchema.foreignCollection);
            const ids = recordIds.map(field => Object.values(field)[0]);
            let key;
            if (relationSchema.type === 'OneToOne') {
                key = relationSchema.originKey;
            }
            else {
                [key] = schema_1.default.getPrimaryKeys(relation.schema);
            }
            const idsFilter = new unpaginated_1.default({ conditionTree: new leaf_1.default(key, 'In', ids) });
            updates.push(relation.update(caller, idsFilter, patch[relationName]));
        }
        return updates;
    }
    async getImpactedRecordByUpdate(caller, relations, filter) {
        const records = [];
        for (const relationName of relations) {
            const relationSchema = this.schema.fields[relationName];
            let projection;
            if (relationSchema.type === 'OneToOne') {
                projection = new projection_1.default(...schema_1.default.getPrimaryKeys(this.schema));
            }
            else if (relationSchema.type === 'ManyToOne') {
                projection = new projection_1.default(relationSchema.foreignKey);
            }
            records.push(this.list(caller, filter, projection));
        }
        return Promise.all(records);
    }
    async applyDefinitions(caller, patch, action, stackCalls = []) {
        if (Object.keys(patch).length === 0)
            return {};
        const replacedDefinitionsColumns = this.getReplacedDefinitionsColumns(patch);
        WriteDecorator.checkCyclicDependency(replacedDefinitionsColumns, stackCalls);
        const patches = await this.getDefinitionResults(caller, patch, replacedDefinitionsColumns, action);
        const patchToExplore = {};
        const copyPatch = { ...patch };
        patches.forEach(recordData => {
            const setValueColumn = replacedDefinitionsColumns.shift();
            delete copyPatch[setValueColumn];
            if (!recordData)
                return;
            if (recordData.constructor === Object) {
                record_1.default.validate(this, recordData);
            }
            else {
                throw new Error(`The write handler of ${setValueColumn} should return an object or nothing.`);
            }
            for (const [columnName, value] of Object.entries(recordData)) {
                if (copyPatch[columnName]) {
                    throw new errors_1.ValidationError(`Conflict value on the field "${columnName}". It receives several values.`);
                }
                if (columnName === setValueColumn) {
                    copyPatch[columnName] = value;
                }
                else {
                    patchToExplore[columnName] = value;
                }
            }
        });
        return {
            ...copyPatch,
            ...(await this.applyDefinitions(caller, patchToExplore, action, stackCalls)),
        };
    }
    getReplacedDefinitionsColumns(patch) {
        const patchKeys = Object.keys(patch);
        return Object.keys(this.replacedDefinitions).filter(name => patchKeys.includes(name));
    }
    async getDefinitionResults(caller, patch, columns, action) {
        return Promise.all(columns.map(column => {
            const definition = this.replacedDefinitions[column];
            const context = new context_1.default(this, caller, action, { ...patch });
            return definition(patch[column], context);
        }));
    }
    static checkCyclicDependency(columns, stackCalls) {
        stackCalls.push(...columns);
        if (stackCalls.length !== [...new Set(stackCalls)].length) {
            throw new errors_1.ValidationError(`There is a cyclic dependency on the "${stackCalls.pop()}" column.`);
        }
    }
    getRelationFields(patch, types) {
        return Object.keys(patch).filter(field => types.includes(this.schema.fields[field]?.type));
    }
    getPatchWithoutRelations(patch, relations) {
        const copy = { ...patch };
        relations.forEach(relation => delete copy[relation]);
        return copy;
    }
}
exports.default = WriteDecorator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kZWNvcmF0b3JzL3dyaXRlL2NvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFVQSx5Q0FBK0M7QUFFL0MsbUZBQTBEO0FBQzFELDRGQUFpRjtBQUVqRiw0RkFBK0Q7QUFDL0QsbUZBQTJEO0FBQzNELHFFQUFzRDtBQUN0RCxnRUFBNkM7QUFDN0Msd0RBQWtEO0FBRWxELE1BQXFCLGNBQWUsU0FBUSw4QkFBbUI7SUFBL0Q7O1FBQ1Usd0JBQW1CLEdBQW9DLEVBQUUsQ0FBQztJQW1UcEUsQ0FBQztJQWhUQyxtQkFBbUIsQ0FBQyxTQUFpQixFQUFFLFVBQTJCO1FBQ2hFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQ3hELE1BQU0sSUFBSSxLQUFLLENBQ2Isb0JBQW9CLFNBQVMsMkJBQTJCLElBQUksQ0FBQyxJQUFJLGNBQWMsQ0FDaEYsQ0FBQztTQUNIO1FBRUQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxHQUFHLFVBQVUsQ0FBQztRQUNqRCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRWtCLFlBQVksQ0FBQyxXQUE2QjtRQUMzRCxNQUFNLE1BQU0sR0FBRyxFQUFFLEdBQUcsV0FBVyxFQUFFLE1BQU0sRUFBRSxFQUFFLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7UUFFckUsS0FBSyxNQUFNLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1lBQ3ZELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFrQixDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7U0FDMUQ7UUFFRCxPQUFPLE1BQU0sQ0FB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