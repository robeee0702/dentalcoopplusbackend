"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const collection_decorator_1 = __importDefault(require("../collection-decorator"));
const leaf_1 = __importDefault(require("../../interfaces/query/condition-tree/nodes/leaf"));
const unpaginated_1 = __importDefault(require("../../interfaces/query/filter/unpaginated"));
const projection_1 = __importDefault(require("../../interfaces/query/projection"));
const record_1 = __importDefault(require("../../utils/record"));
const schema_1 = __importDefault(require("../../utils/schema"));
class RelationCollectionDecorator extends collection_decorator_1.default {
    constructor() {
        super(...arguments);
        this.relations = {};
    }
    addRelation(name, partialJoint) {
        const relation = this.relationWithOptionalFields(partialJoint);
        this.checkForeignKeys(relation);
        this.checkOriginKeys(relation);
        this.relations[name] = relation;
        this.markSchemaAsDirty();
    }
    async list(caller, filter, projection) {
        const newFilter = await this.refineFilter(caller, filter);
        const newProjection = projection.replace(this.rewriteField, this).withPks(this);
        const records = await this.childCollection.list(caller, newFilter, newProjection);
        await this.reprojectInPlace(caller, records, projection);
        return projection.apply(records);
    }
    async aggregate(caller, filter, aggregation, limit) {
        const newFilter = await this.refineFilter(caller, filter);
        // No emulated relations are used in the aggregation
        if (Object.keys(aggregation.projection.relations).every(prefix => !this.relations[prefix])) {
            return this.childCollection.aggregate(caller, newFilter, aggregation, limit);
        }
        // Fallback to full emulation.
        return aggregation.apply(await this.list(caller, filter, aggregation.projection), caller.timezone, limit);
    }
    refineSchema(subSchema) {
        const schema = { ...subSchema, fields: { ...subSchema.fields } };
        for (const [name, relation] of Object.entries(this.relations)) {
            schema.fields[name] = relation;
        }
        return schema;
    }
    async refineFilter(caller, filter) {
        return filter?.override({
            conditionTree: await filter.conditionTree?.replaceLeafsAsync(leaf => this.rewriteLeaf(caller, leaf), this),
            // Replace sort in emulated relations to
            // - sorting by the fk of the relation for many to one
            // - removing the sort altogether for one to one
            //
            // This is far from ideal, but the best that can be done without taking a major
            // performance hit.
            // Customers which want proper sorting should enable emulation in the associated
            // middleware
            sort: filter.sort?.replaceClauses(clause => this.rewriteField(clause.field).map(field => ({ ...clause, field }))),
        });
    }
    relationWithOptionalFields(partialJoint) {
        const relation = { ...partialJoint };
        const target = this.dataSource.getCollection(relation.foreignCollection);
        if (relation.type === 'ManyToOne') {
            relation.foreignKeyTarget ?? (relation.foreignKeyTarget = schema_1.default.getPrimaryKeys(target.schema)[0]);
        }
        else if (relation.type === 'OneToOne' || relation.type === 'OneToMany') {
            relation.originKeyTarget ?? (relation.originKeyTarget = schema_1.default.getPrimaryKeys(this.schema)[0]);
        }
        else if (relation.type === 'ManyToMany') {
            relation.originKeyTarget ?? (relation.originKeyTarget = schema_1.default.getPrimaryKeys(this.schema)[0]);
            relation.foreignKeyTarget ?? (relation.foreignKeyTarget = schema_1.default.getPrimaryKeys(target.schema)[0]);
        }
        return relation;
    }
    checkForeignKeys(relation) {
        if (relation.type === 'ManyToOne' || relation.type === 'ManyToMany') {
            RelationCollectionDecorator.checkKeys(relation.type === 'ManyToMany'
                ? this.dataSource.getCollection(relation.throughCollection)
                : this, this.dataSource.getCollection(relation.foreignCollection), relation.foreignKey, relation.foreignKeyTarget);
        }
    }
    checkOriginKeys(relation) {
        if (relation.type === 'OneToMany' ||
            relation.type === 'OneToOne' ||
            relation.type === 'ManyToMany') {
            RelationCollectionDecorator.checkKeys(relation.type === 'ManyToMany'
                ? this.dataSource.getCollection(relation.throughCollection)
                : this.dataSource.getCollection(relation.foreignCollection), this, relation.originKey, relation.originKeyTarget);
        }
    }
    static checkKeys(owner, targetOwner, keyName, targetName) {
        RelationCollectionDecorator.checkColumn(owner, keyName);
        RelationCollectionDecorator.checkColumn(targetOwner, targetName);
        const key = owner.schema.fields[keyName];
        const target = targetOwner.schema.fields[targetName];
        if (key.columnType !== target.columnType) {
            throw new Error(`Types from '${owner.name}.${keyName}' and ` +
                `'${targetOwner.name}.${targetName}' do not match.`);
        }
    }
    static checkColumn(owner, name) {
        const column = owner.schema.fields[name];
        if (!column || column.type !== 'Column') {
            throw new Error(`Column not found: '${owner.name}.${name}'`);
        }
        if (!column.filterOperators?.has('In')) {
            throw new Error(`Column does not support the In operator: '${owner.name}.${name}'`);
        }
    }
    rewriteField(field) {
        const prefix = field.split(':').shift();
        const schema = this.schema.fields[prefix];
        if (schema.type === 'Column')
            return [field];
        const relation = this.dataSource.getCollection(schema.foreignCollection);
        let result = [];
        if (!this.relations[prefix]) {
            result = relation
                .rewriteField(field.substring(prefix.length + 1))
                .map(subField => `${prefix}:${subField}`);
        }
        else if (schema.type === 'ManyToOne') {
            result = [schema.foreignKey];
        }
        else if (schema.type === 'OneToOne' ||
            schema.type === 'OneToMany' ||
            schema.type === 'ManyToMany') {
            result = [schema.originKeyTarget];
        }
        return result;
    }
    async rewriteLeaf(caller, leaf) {
        const prefix = leaf.field.split(':').shift();
        const schema = this.schema.fields[prefix];
        if (schema.type === 'Column')
            return leaf;
        const relation = this.dataSource.getCollection(schema.foreignCollection);
        let result = leaf;
        if (!this.relations[prefix]) {
            result = (await relation.rewriteLeaf(caller, leaf.unnest())).nest(prefix);
        }
        else if (schema.type === 'ManyToOne') {
            const records = await relation.list(caller, new unpaginated_1.default({ conditionTree: leaf.unnest() }), new projection_1.default().withPks(this));
            result = new leaf_1.default(schema.foreignKey, 'In', [
                ...new Set(records
                    .map(record => record_1.default.getFieldValue(record, schema.foreignKeyTarget))
                    .filter(v => v !== null)),
            ]);
        }
        else if (schema.type === 'OneToOne') {
            const records = await relation.list(caller, new unpaginated_1.default({ conditionTree: leaf.unnest() }), new projection_1.default(schema.originKey));
            result = new leaf_1.default(schema.originKeyTarget, 'In', [
                ...new Set(records
                    .map(record => record_1.default.getFieldValue(record, schema.originKey))
                    .filter(v => v !== null)),
            ]);
        }
        return result;
    }
    async reprojectInPlace(caller, records, projection) {
        const promises = Object.entries(projection.relations).map(async ([prefix, subProjection]) => this.reprojectRelationInPlace(caller, records, prefix, subProjection));
        await Promise.all(promises);
    }
    async reprojectRelationInPlace(caller, records, name, projection) {
        const schema = this.schema.fields[name];
        const association = this.dataSource.getCollection(schema.foreignCollection);
        if (!this.relations[name]) {
            await association.reprojectInPlace(caller, records.map(r => r[name]).filter(Boolean), projection);
        }
        else if (schema.type === 'ManyToOne') {
            const ids = records.map(record => record[schema.foreignKey]).filter(fk => fk !== null);
            const subFilter = new unpaginated_1.default({
                conditionTree: new leaf_1.default(schema.foreignKeyTarget, 'In', [...new Set(ids)]),
            });
            const subRecords = await association.list(caller, subFilter, projection.union([schema.foreignKeyTarget]));
            for (const record of records) {
                record[name] = subRecords.find(sr => sr[schema.foreignKeyTarget] === record[schema.foreignKey]);
            }
        }
        else if (schema.type === 'OneToOne' || schema.type === 'OneToMany') {
            const ids = records.map(record => record[schema.originKeyTarget]).filter(okt => okt !== null);
            const subFilter = new unpaginated_1.default({
                conditionTree: new leaf_1.default(schema.originKey, 'In', [...new Set(ids)]),
            });
            const subRecords = await association.list(caller, subFilter, projection.union([schema.originKey]));
            for (const record of records) {
                record[name] = subRecords.find(sr => sr[schema.originKey] === record[schema.originKeyTarget]);
            }
        }
    }
}
exports.default = RelationCollectionDecorator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kZWNvcmF0b3JzL3JlbGF0aW9uL2NvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFNQSxtRkFBMEQ7QUFFMUQsNEZBQWlGO0FBRWpGLDRGQUErRDtBQUUvRCxtRkFBMkQ7QUFDM0QsZ0VBQTZDO0FBQzdDLGdFQUE2QztBQUU3QyxNQUFxQiwyQkFBNEIsU0FBUSw4QkFBbUI7SUFBNUU7O1FBRVksY0FBUyxHQUFtQyxFQUFFLENBQUM7SUErUjNELENBQUM7SUE3UkMsV0FBVyxDQUFDLElBQVksRUFBRSxZQUFtQztRQUMzRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFL0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7UUFDaEMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVRLEtBQUssQ0FBQyxJQUFJLENBQ2pCLE1BQWMsRUFDZCxNQUF1QixFQUN2QixVQUFzQjtRQUV0QixNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzFELE1BQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEYsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRWxGLE1BQU0sSUFBSSxD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