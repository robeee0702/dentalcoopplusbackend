"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const datasource_toolkit_1 = require("@forestadmin/datasource-toolkit");
const luxon_1 = require("luxon");
const mongoose_1 = require("mongoose");
const schema_1 = __importDefault(require("../../mongoose/schema"));
const STRING_OPERATORS = ['Like', 'ILike', 'NotContains', 'LongerThan', 'ShorterThan'];
/** Transform a forest admin filter into mongo pipeline */
class FilterGenerator {
    static filter(model, prefix, filter) {
        const schema = schema_1.default.fromModel(model).getSubSchema(prefix, true);
        const fields = new Set();
        const tree = filter?.conditionTree;
        const match = this.computeMatch(schema, tree, fields);
        const sort = this.computeSort(filter?.sort);
        const pipeline = [];
        if (fields.size)
            pipeline.push(this.computeFields(fields));
        if (match)
            pipeline.push({ $match: match });
        if (sort)
            pipeline.push({ $sort: sort });
        if (filter?.page?.skip !== undefined)
            pipeline.push({ $skip: filter.page.skip });
        if (filter?.page?.limit !== undefined)
            pipeline.push({ $limit: filter.page.limit });
        return pipeline;
    }
    static computeMatch(schema, tree, fields) {
        if (tree instanceof datasource_toolkit_1.ConditionTreeBranch) {
            return {
                [`$${tree.aggregator.toLowerCase()}`]: tree.conditions.map(condition => this.computeMatch(schema, condition, fields)),
            };
        }
        if (tree instanceof datasource_toolkit_1.ConditionTreeLeaf) {
            const value = this.formatAndCastLeafValue(schema, tree, fields);
            const condition = this.buildMatchCondition(tree.operator, value);
            return { [this.formatNestedFieldPath(tree.field)]: condition };
        }
        return null;
    }
    static formatAndCastLeafValue(schema, leaf, fields) {
        // @fixme not a big fan of modifying the condition tree here.
        // those objects should be frozen, as the modification will show if the condition tree
        // is used after the request (for instance for "after hooks").
        let { value } = leaf;
        leaf.field = this.formatNestedFieldPath(leaf.field);
        const { isArray, schemaType: { instance }, } = schema.getSubSchema(leaf.field, true);
        // @fixme I'm really not sure that this can work in all cases.
        // It assumes that the type of the value is the same than the type of the column
        // which is not the case for many operators.
        if (isArray) {
            if (instance === 'Date' &&
                Array.isArray(value) &&
                value.every(v => luxon_1.DateTime.fromISO(v).isValid)) {
                value = value.map(v => new Date(v));
            }
            else if (instance === 'ObjectID' &&
                Array.isArray(value) &&
                value.every(v => (0, mongoose_1.isValidObjectId)(v))) {
                value = value.map(id => new mongoose_1.Types.ObjectId(id));
            }
        }
        else if (instance === 'ObjectID') {
            if (STRING_OPERATORS.includes(leaf.operator)) {
                fields.add(leaf.field);
                leaf.field = this.formatStringFieldName(leaf.field);
            }
            else if (Array.isArray(value) && value.every(v => (0, mongoose_1.isValidObjectId)(v))) {
                value = value.map(id => new mongoose_1.Types.ObjectId(id));
            }
            else if ((0, mongoose_1.isValidObjectId)(value)) {
                value = new mongoose_1.Types.ObjectId(value);
            }
        }
        else if (instance === 'Date') {
            value = new Date(value);
        }
        return value;
    }
    static buildMatchCondition(operator, formattedLeafValue) {
        switch (operator) {
            case 'GreaterThan':
                return { $gt: formattedLeafValue };
            case 'LessThan':
                return { $lt: formattedLeafValue };
            case 'Equal':
                return { $eq: formattedLeafValue };
            case 'NotEqual':
                return { $ne: formattedLeafValue };
            case 'In':
                return { $in: formattedLeafValue };
            case 'IncludesAll':
                return { $all: formattedLeafValue };
            case 'NotContains':
                return { $not: new RegExp(`.*${formattedLeafValue}.*`) };
            case 'Like':
                return this.like(formattedLeafValue, true);
            case 'ILike':
                return this.like(formattedLeafValue, false);
            case 'Present':
                return { $exists: true, $ne: null };
            default:
                throw new Error(`Unsupported '${operator}' operator`);
        }
    }
    /** @see https://stackoverflow.com/a/18418386/1897495 */
    static like(pattern, caseSensitive) {
        let regexp = pattern;
        // eslint-disable-next-line no-useless-escape
        regexp = regexp.replace(/([\.\\\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:\-])/g, '\\$1');
        regexp = regexp.replace(/%/g, '.*').replace(/_/g, '.');
        return RegExp(`^${regexp}$`, caseSensitive ? 'g' : 'gi');
    }
    static computeSort(sorts) {
        if (!sorts || sorts.length === 0)
            return null;
        const result = {};
        for (const { field, ascending } of sorts) {
            const formattedField = this.formatNestedFieldPath(field);
            result[formattedField] = ascending ? 1 : -1;
        }
        return result;
    }
    static computeFields(fields) {
        return Array.from(fields).reduce((computed, field) => {
            const stringField = this.formatStringFieldName(field);
            computed.$addFields[stringField] = { $toString: `$${field}` };
            return computed;
        }, { $addFields: {} });
    }
    static formatNestedFieldPath(field) {
        return field.replace(/:/g, '.');
    }
    static formatStringFieldName(field) {
        const parentPath = this.getParentPath(field);
        const fieldName = this.getFieldName(field);
        if (parentPath === field) {
            return `string_${fieldName}`;
        }
        return `${parentPath}.string_${fieldName}`;
    }
    static getParentPath(path) {
        if (!path.includes('.')) {
            return path;
        }
        return path.split('.').slice(0, -1).join('.');
    }
    static getFieldName(path) {
        if (!path.includes('.')) {
            return path;
        }
        return path.split('.').slice(-1).join('.');
    }
}
exports.default = FilterGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3V0aWxzL3BpcGVsaW5lL2ZpbHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHdFQU15QztBQUN6QyxpQ0FBaUM7QUFDakMsdUNBQXdFO0FBQ3hFLG1FQUFtRDtBQUVuRCxNQUFNLGdCQUFnQixHQUFHLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0FBRXZGLDBEQUEwRDtBQUMxRCxNQUFxQixlQUFlO0lBQ2xDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBcUIsRUFBRSxNQUFjLEVBQUUsTUFBdUI7UUFDMUUsTUFBTSxNQUFNLEdBQUcsZ0JBQWMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUUxRSxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQ2pDLE1BQU0sSUFBSSxHQUFHLE1BQU0sRUFBRSxhQUFhLENBQUM7UUFDbkMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3RELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTVDLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLE1BQU0sQ0FBQyxJQUFJO1lBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDM0QsSUFBSSxLQUFLO1lBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLElBQUksSUFBSTtZQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMs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