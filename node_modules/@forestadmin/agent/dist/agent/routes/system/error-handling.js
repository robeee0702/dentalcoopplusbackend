"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const koa_1 = require("koa");
const datasource_toolkit_1 = require("@forestadmin/datasource-toolkit");
const types_1 = require("../../types");
const base_route_1 = __importDefault(require("../base-route"));
class ErrorHandling extends base_route_1.default {
    constructor() {
        super(...arguments);
        this.type = types_1.RouteType.ErrorHandler;
    }
    setupRoutes(router) {
        router.use(this.errorHandler.bind(this));
    }
    async errorHandler(context, next) {
        try {
            await next();
        }
        catch (e) {
            context.response.status = this.getErrorStatus(e);
            context.response.body = { errors: [{ detail: this.getErrorMessage(e) }] };
            if (!this.options.isProduction) {
                process.nextTick(() => this.debugLogError(context, e));
            }
        }
    }
    getErrorStatus(error) {
        if (error instanceof datasource_toolkit_1.ValidationError)
            return types_1.HttpCode.BadRequest;
        if (error instanceof datasource_toolkit_1.ForbiddenError)
            return types_1.HttpCode.Forbidden;
        if (error instanceof datasource_toolkit_1.UnprocessableError)
            return types_1.HttpCode.Unprocessable;
        if (error instanceof koa_1.HttpError)
            return error.status;
        return types_1.HttpCode.InternalServerError;
    }
    getErrorMessage(error) {
        if (error instanceof koa_1.HttpError ||
            error instanceof datasource_toolkit_1.ValidationError ||
            error instanceof datasource_toolkit_1.UnprocessableError ||
            error instanceof datasource_toolkit_1.ForbiddenError) {
            return error.message;
        }
        if (this.options.customizeErrorMessage) {
            const message = this.options.customizeErrorMessage(error);
            if (message)
                return message;
        }
        return 'Unexpected error';
    }
    debugLogError(context, error) {
        const { request } = context;
        const query = JSON.stringify(request.query, null, ' ')?.replace(/"/g, '');
        console.error('');
        console.error(`\x1b[33m===== An exception was raised =====\x1b[0m`);
        console.error(`${request.method} \x1b[34m${request.path}\x1b[36m?${query}\x1b[0m`);
        if (request.method === 'POST' || request.method === 'PUT' || request.method === 'PATCH') {
            const body = JSON.stringify(request.body, null, ' ')?.replace(/"/g, '');
            console.error('');
            console.error(`Body \x1b[36m${body}\x1b[0m`);
        }
        console.error('');
        console.error('\x1b[31m', error.message, '\x1b[0m');
        console.error('');
        console.error(error.stack);
        console.error(`\x1b[33m===================================\x1b[0m`);
        console.error('');
    }
}
exports.default = ErrorHandling;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3ItaGFuZGxpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYWdlbnQvcm91dGVzL3N5c3RlbS9lcnJvci1oYW5kbGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLDZCQUErQztBQUMvQyx3RUFJeUM7QUFHekMsdUNBQWtEO0FBQ2xELCtEQUFzQztBQUV0QyxNQUFxQixhQUFjLFNBQVEsb0JBQVM7SUFBcEQ7O1FBQ0UsU0FBSSxHQUFHLGlCQUFTLENBQUMsWUFBWSxDQUFDO0lBbUVoQyxDQUFDO0lBakVDLFdBQVcsQ0FBQyxNQUFjO1FBQ3hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRU8sS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFnQixFQUFFLElBQVU7UUFDckQsSUFBSTtZQUNGLE1BQU0sSUFBSSxFQUFFLENBQUM7U0FDZDtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqRCxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFFMUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFO2dCQUM5QixPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDeEQ7U0FDRjtJQUNILENBQUM7SUFFTyxjQUFjLENBQUMsS0FBWTtRQUNqQyxJQUFJLEtBQUssWUFBWSxvQ0FBZTtZQUFFLE9B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